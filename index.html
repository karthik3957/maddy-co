<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify AI Playlist Generator (Genre Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spotify-green {
            background-color: #1DB954;
        }
        .spotify-green:hover {
            background-color: #1ED760;
        }
        .genre-tag {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .genre-tag.selected {
            background-color: #1DB954;
            color: white;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="main-container" class="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 space-y-6">
        
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Spotify AI Playlist Generator</h1>
            <p class="text-gray-400">Create playlists from your favorite genres. Works for Free & Premium!</p>
        </div>

        <!-- Client ID Input Section -->
        <div id="client-id-section">
            <label for="clientId" class="block text-sm font-medium text-gray-300 mb-2">Spotify Client ID</label>
            <input type="text" id="clientId" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-spotify-green focus:outline-none" placeholder="Enter your Spotify Client ID here">
        </div>

        <!-- Main Action/Login Button -->
        <div id="login-section" class="text-center pt-4">
            <button id="login-button" class="spotify-green text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200 w-full md:w-auto">
                Login with Spotify
            </button>
        </div>

        <!-- Logged In State / Results -->
        <div id="loggedin-section" class="hidden text-center space-y-6">
            <div id="user-profile" class="flex items-center justify-between">
                <!-- User profile info will be injected here -->
            </div>
            
            <!-- Genre Selection -->
            <div>
                <h3 class="text-xl font-bold mb-4">Select up to 5 genres to inspire your playlist:</h3>
                <div id="genre-container" class="flex flex-wrap justify-center gap-3">
                    <!-- Genres will be injected here -->
                </div>
            </div>

            <button id="generate-playlist-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200 w-full md:w-auto disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                Create My AI Playlist
            </button>
            <div id="status" class="text-gray-400 pt-4 space-y-2">
                <!-- Status messages will appear here -->
            </div>
            <div id="playlist-result" class="hidden pt-4">
                <h3 class="text-2xl font-bold text-spotify-green">Success!</h3>
                <p class="text-gray-300 mt-2">Your new playlist is ready.</p>
                <a id="playlist-link" href="#" target="_blank" class="mt-4 inline-block spotify-green text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200">
                    Open Playlist
                </a>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        // Reduced scopes as we no longer need to read user top tracks
        const SCOPES = 'user-read-private user-read-email playlist-modify-public playlist-modify-private';
        const TOKEN_ENDPOINT = 'https://accounts.spotify.com/api/token';
        const AUTH_ENDPOINT = 'https://accounts.spotify.com/authorize';
        const GENRES = [
            'acoustic', 'afrobeat', 'alt-rock', 'alternative', 'ambient', 'anime', 'black-metal', 'bluegrass', 'blues', 'bossanova', 
            'brazil', 'breakbeat', 'british', 'cantopop', 'chicago-house', 'children', 'chill', 'classical', 'club', 'comedy', 
            'country', 'dance', 'dancehall', 'death-metal', 'deep-house', 'detroit-techno', 'disco', 'disney', 'drum-and-bass', 
            'dub', 'dubstep', 'edm', 'electro', 'electronic', 'emo', 'folk', 'forro', 'french', 'funk', 'garage', 'german', 
            'gospel', 'goth', 'grindcore', 'groove', 'grunge', 'guitar', 'happy', 'hard-rock', 'hardcore', 'hardstyle', 
            'heavy-metal', 'hip-hop', 'holidays', 'honky-tonk', 'house', 'idm', 'indian', 'indie', 'indie-pop', 'industrial', 
            'iranian', 'j-dance', 'j-idol', 'j-pop', 'j-rock', 'jazz', 'k-pop', 'kids', 'latin', 'latino', 'malay', 'mandopop', 
            'metal', 'metal-misc', 'metalcore', 'minimal-techno', 'movies', 'mpb', 'new-age', 'new-release', 'opera', 'pagode', 
            'party', 'philippines-opm', 'piano', 'pop', 'pop-film', 'post-dubstep', 'power-pop', 'progressive-house', 'psych-rock', 
            'punk', 'punk-rock', 'r-n-b', 'rainy-day', 'reggae', 'reggaeton', 'road-trip', 'rock', 'rock-n-roll', 'rockabilly', 
            'romance', 'sad', 'salsa', 'samba', 'sertanejo', 'show-tunes', 'singer-songwriter', 'ska', 'sleep', 'songwriter', 
            'soul', 'soundtracks', 'spanish', 'study', 'summer', 'swedish', 'synth-pop', 'tango', 'techno', 'trance', 'trip-hop', 
            'turkish', 'work-out', 'world-music'
        ];

        // --- UI ELEMENTS ---
        const clientIdInput = document.getElementById('clientId');
        const loginButton = document.getElementById('login-button');
        const generatePlaylistButton = document.getElementById('generate-playlist-button');
        const statusDiv = document.getElementById('status');
        const userProfileDiv = document.getElementById('user-profile');
        const playlistResultDiv = document.getElementById('playlist-result');
        const playlistLink = document.getElementById('playlist-link');
        const clientIdSection = document.getElementById('client-id-section');
        const loginSection = document.getElementById('login-section');
        const loggedinSection = document.getElementById('loggedin-section');
        const genreContainer = document.getElementById('genre-container');

        let accessToken = null;
        let userId = null;

        // --- ON PAGE LOAD ---
        window.onload = async () => {
            const storedClientId = localStorage.getItem('spotifyClientId');
            if (storedClientId) clientIdInput.value = storedClientId;

            const storedToken = sessionStorage.getItem('spotify_access_token');
            if (storedToken) {
                accessToken = storedToken;
                await showLoggedInState();
                return;
            }

            const args = new URLSearchParams(window.location.search);
            const code = args.get('code');

            if (code) {
                try {
                    await exchangeCodeForToken(code);
                    await showLoggedInState();
                } catch (error) {
                    console.error("Error getting token:", error);
                    alert("There was an error authenticating with Spotify.");
                }
                const url = new URL(window.location.href);
                url.search = '';
                window.history.replaceState({}, document.title, url);
            }
        };

        // --- AUTHENTICATION & UI ---
        async function login() {
            const clientId = clientIdInput.value;
            if (!clientId) {
                alert('Please enter your Spotify Client ID first.');
                return;
            }
            localStorage.setItem('spotifyClientId', clientId);

            const codeVerifier = generateRandomString(64);
            localStorage.setItem('code_verifier', codeVerifier);
            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64urlencode(hashed);

            const params = new URLSearchParams({
                client_id: clientId, response_type: 'code', redirect_uri: REDIRECT_URI,
                scope: SCOPES, code_challenge_method: 'S256', code_challenge: codeChallenge,
            });
            window.location.href = `${AUTH_ENDPOINT}?${params.toString()}`;
        }

        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            const clientId = clientIdInput.value;
            const response = await fetch(TOKEN_ENDPOINT, {
                method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    client_id: clientId, grant_type: 'authorization_code', code: code,
                    redirect_uri: REDIRECT_URI, code_verifier: codeVerifier,
                }),
            });
            if (!response.ok) throw new Error('Failed to exchange code for token');
            const data = await response.json();
            accessToken = data.access_token;
            sessionStorage.setItem('spotify_access_token', accessToken);
        }

        function logout() {
            accessToken = null;
            userId = null;
            sessionStorage.removeItem('spotify_access_token');
            localStorage.removeItem('code_verifier');
            clientIdSection.classList.remove('hidden');
            loginSection.classList.remove('hidden');
            loggedinSection.classList.add('hidden');
            statusDiv.innerHTML = '';
            playlistResultDiv.classList.add('hidden');
        }

        async function showLoggedInState() {
            clientIdSection.classList.add('hidden');
            loginSection.classList.add('hidden');
            loggedinSection.classList.remove('hidden');
            populateGenres();
            try {
                const profile = await fetchUserProfile();
                userId = profile.id;
                userProfileDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${profile.images[0]?.url || 'https://placehold.co/100x100/191414/FFFFFF?text=User'}" alt="Profile Picture" class="w-16 h-16 rounded-full">
                        <p class="text-lg font-semibold">Welcome, ${profile.display_name}!</p>
                    </div>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-full">Logout</button>
                `;
                document.getElementById('logout-button').addEventListener('click', logout);
            } catch (error) {
                console.error('Error fetching user profile:', error);
                statusDiv.innerHTML = `<p class="text-red-400">Error fetching your profile. Your session may have expired.</p>`;
                logout();
            }
        }
        
        function populateGenres() {
            genreContainer.innerHTML = '';
            GENRES.forEach(genre => {
                const tag = document.createElement('div');
                tag.textContent = genre;
                tag.className = 'genre-tag bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-full';
                tag.dataset.genre = genre;
                tag.addEventListener('click', toggleGenre);
                genreContainer.appendChild(tag);
            });
        }

        function toggleGenre(event) {
            const tag = event.target;
            const selectedCount = document.querySelectorAll('.genre-tag.selected').length;
            if (tag.classList.contains('selected')) {
                tag.classList.remove('selected');
            } else {
                if (selectedCount < 5) {
                    tag.classList.add('selected');
                } else {
                    alert('You can select a maximum of 5 genres.');
                }
            }
            // Enable/disable button based on selection
            const newSelectedCount = document.querySelectorAll('.genre-tag.selected').length;
            generatePlaylistButton.disabled = newSelectedCount === 0;
        }

        // --- SPOTIFY API CALLS ---
        async function spotifyFetch(endpoint, method, body) {
            if (!accessToken) throw new Error("Not authenticated. Please log in.");
            const res = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                method, headers: { 'Authorization': `Bearer ${accessToken}` },
                body: body ? JSON.stringify(body) : null
            });
            if (!res.ok) {
                let errorMsg = `Error: ${res.status} ${res.statusText}`;
                if (res.status === 401) {
                    logout();
                    errorMsg = "Your session has expired. Please log in again.";
                } else {
                    try {
                        const errorData = await res.json();
                        if (errorData.error && errorData.error.message) errorMsg = `Spotify API Error: ${errorData.error.message}`;
                    } catch (e) { /* Ignore parsing error */ }
                }
                throw new Error(errorMsg);
            }
            if (res.status === 204 || res.status === 201) return;
            return res.json();
        }

        function fetchUserProfile() { return spotifyFetch('/me', 'GET'); }
        function fetchRecommendations(seedData) {
            const params = new URLSearchParams(seedData).toString();
            return spotifyFetch(`/recommendations?${params}`, 'GET');
        }
        function createPlaylist(name, description) {
            return spotifyFetch(`/users/${userId}/playlists`, 'POST', { name, description, public: false });
        }
        function addTracksToPlaylist(playlistId, trackUris) {
            return spotifyFetch(`/playlists/${playlistId}/tracks`, 'POST', { uris: trackUris });
        }

        // --- MAIN LOGIC ---
        async function generatePlaylist() {
            const selectedGenres = Array.from(document.querySelectorAll('.genre-tag.selected')).map(tag => tag.dataset.genre);
            if (selectedGenres.length === 0) {
                alert('Please select at least one genre.');
                return;
            }
            try {
                generatePlaylistButton.disabled = true;
                generatePlaylistButton.textContent = 'Working...';
                playlistResultDiv.classList.add('hidden');
                statusDiv.innerHTML = '';
                
                addStatus(`🎶 Finding songs for: ${selectedGenres.join(', ')}...`);
                const recommendations = await fetchRecommendations({ seed_genres: selectedGenres.join(','), limit: 30 });
                const recommendedTrackUris = recommendations.tracks.map(track => track.uri);

                addStatus('✨ Creating a new playlist...');
                const playlistName = `AI Mix: ${selectedGenres.slice(0,2).join(' & ')}`;
                const playlistDescription = `A playlist generated from the genres: ${selectedGenres.join(', ')}.`;
                const newPlaylist = await createPlaylist(playlistName, playlistDescription);

                addStatus(`➕ Adding ${recommendedTrackUris.length} songs to "${playlistName}"...`);
                await addTracksToPlaylist(newPlaylist.id, recommendedTrackUris);

                playlistLink.href = newPlaylist.external_urls.spotify;
                playlistResultDiv.classList.remove('hidden');
                statusDiv.innerHTML = '';

            } catch (error) {
                console.error('Full error object:', error);
                addStatus(`An error occurred: ${error.message}. Please try again.`, 'error');
            } finally {
                generatePlaylistButton.disabled = false;
                generatePlaylistButton.textContent = 'Create My AI Playlist';
            }
        }
        
        function addStatus(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = type === 'error' ? 'text-red-400' : 'text-gray-400';
            statusDiv.appendChild(p);
        }

        // --- PKCE HELPERS ---
        function generateRandomString(length) {
            let text = ''; const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
            return text;
        }
        async function sha256(plain) {
            const encoder = new TextEncoder(); const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }
        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', login);
        generatePlaylistButton.addEventListener('click', generatePlaylist);

    </script>
</body>
</html>
